<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Debris Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.9);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .loading {
            display: none;
        }
        .loading.show {
            display: inline-block;
        }
        .risk-table {
            max-height: 400px;
            overflow-y: auto;
        }
        .sci-fi-log-panel {
            font-size: 1rem;
            letter-spacing: 0.03em;
            border: 1px solid #00ffe7;
            background: #181c2f;
            color: #00ffe7;
            box-shadow: 0 0 10px #00ffe7, 0 0 20px #181c2f inset;
            font-family: 'Share Tech Mono', monospace;
        }
        .log-success { color: #00ff00; text-shadow: 0 0 5px #00ff00; }
        .log-error { color: #ff003c; text-shadow: 0 0 5px #ff003c; }
        .log-info { color: #00ffe7; text-shadow: 0 0 5px #00ffe7; }
        .log-timer { font-size: 0.85em; color: #fff176; margin-left: 8px; }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h1 class="display-4 mb-3">
                            <i class="fas fa-satellite"></i> Space Debris Tracker
                        </h1>
                        <p class="lead">Predict future positions of space debris and assess collision risk using ML</p>
                        <div class="mt-3">
                            <a href="/docs" class="btn btn-secondary me-2" target="_blank">
                                <i class="fas fa-book"></i> API Documentation
                            </a>
                            <a href="/health" class="btn btn-outline-secondary" target="_blank">
                                <i class="fas fa-heartbeat"></i> Health Check
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Global Status Dashboard -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-globe"></i> Global Activity Log</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="global-status-dashboard">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="status-indicator" id="download-status"></span>
                                    <span><strong>TLE Data Download</strong></span>
                                </div>
                                <div class="ms-4">
                                    <small class="text-muted">Last download: <span id="last-download-time">Never</span></small><br>
                                    <small class="text-muted">Next available: <span id="download-countdown">Ready now</span></small><br>
                                    <small class="text-muted">Total downloads: <span id="download-count">0</span></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="status-indicator" id="training-status"></span>
                                    <span><strong>Model Training</strong></span>
                                </div>
                                <div class="ms-4">
                                    <small class="text-muted">Last training: <span id="last-training-time">Never</span></small><br>
                                    <small class="text-muted">Next available: <span id="training-countdown">Ready now</span></small><br>
                                    <small class="text-muted">Total trainings: <span id="training-count">0</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Dashboard -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="status-dashboard">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <span class="status-indicator" id="tle-status"></span>
                                    <span>TLE Data</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <span class="status-indicator" id="orbital-status"></span>
                                    <span>Orbital Parameters</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <span class="status-indicator" id="model-status"></span>
                                    <span>ML Model</span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    <span class="status-indicator" id="scaler-status"></span>
                                    <span>Data Scaler</span>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <small class="text-muted">Objects tracked: <span id="object-count">0</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> Control Panel</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="downloadData()">
                                    <i class="fas fa-download"></i> Download TLE Data
                                    <i class="fas fa-spinner fa-spin loading" id="download-loading"></i>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="parseData()">
                                    <i class="fas fa-cogs"></i> Parse Data
                                    <i class="fas fa-spinner fa-spin loading" id="parse-loading"></i>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="trainModel()">
                                    <i class="fas fa-brain"></i> Train Model
                                    <i class="fas fa-spinner fa-spin loading" id="train-loading"></i>
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="analyzeRisks()">
                                    <i class="fas fa-exclamation-triangle"></i> Analyze Risks
                                    <i class="fas fa-spinner fa-spin loading" id="risk-loading"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Collision Risks</h5>
                    </div>
                    <div class="card-body">
                        <div id="risk-results">
                            <p class="text-muted">Click "Analyze Risks" to see collision risk assessment.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-info-circle"></i> System Log</h5>
                        <button id="toggle-bg-log" class="btn btn-outline-info btn-sm" onclick="toggleBgLog()">
                            <i class="fas fa-terminal"></i> Show Background Logs
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="system-log" style="max-height: 300px; overflow-y: auto;">
                            <p class="text-muted">System messages will appear here...</p>
                        </div>
                        <div id="bg-log-panel" style="display:none; margin-top:20px;">
                            <div class="sci-fi-log-panel" style="max-height:200px; overflow-y:auto; background:#181c2f; border-radius:8px; padding:10px; font-family:'Share Tech Mono', monospace; color:#00ffe7; box-shadow:0 0 10px #00ffe7,0 0 20px #181c2f inset;">
                                <div id="bg-log-entries"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load initial status
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            startGlobalStatusPolling(); // Start polling for global status
        });

        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    updateStatusIndicator('tle-status', data.tle_data);
                    updateStatusIndicator('orbital-status', data.orbital_params);
                    updateStatusIndicator('model-status', data.model);
                    updateStatusIndicator('scaler-status', data.scaler);
                    document.getElementById('object-count').textContent = data.object_count || 0;
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }

        function updateStatusIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            element.className = 'status-indicator ' + (status ? 'status-success' : 'status-error');
        }

        function showLoading(buttonId) {
            document.getElementById(buttonId).classList.add('show');
        }

        function hideLoading(buttonId) {
            document.getElementById(buttonId).classList.remove('show');
        }

        function logMessage(message, type = 'info') {
            const logDiv = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-sm`;
            messageDiv.innerHTML = `<small>[${timestamp}] ${message}</small>`;
            logDiv.appendChild(messageDiv);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function downloadData() {
            showLoading('download-loading');
            logMessage('Downloading TLE data from Space-Track.org...');
            
            fetch('/api/download-data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading('download-loading');
                    if (data.status === 'success') {
                        logMessage(data.message, 'success');
                        updateStatus();
                        updateGlobalStatus('download-status', true);
                        updateGlobalStatus('last-download-time', new Date().toLocaleTimeString());
                        updateGlobalStatus('download-count', data.total_downloads);
                        // startDownloadCountdown(); // Removed 1-second countdown
                    } else {
                        logMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading('download-loading');
                    logMessage('Error downloading data: ' + error.message, 'error');
                });
        }

        function parseData() {
            showLoading('parse-loading');
            logMessage('Parsing TLE data and extracting orbital parameters...');
            
            fetch('/api/parse-data', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading('parse-loading');
                    if (data.status === 'success') {
                        logMessage(data.message, 'success');
                        updateStatus();
                    } else {
                        logMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading('parse-loading');
                    logMessage('Error parsing data: ' + error.message, 'error');
                });
        }

        // --- Live System Log Polling ---
        let systemLogInterval = null;
        function startSystemLogPolling() {
            if (systemLogInterval) return;
            fetchSystemLogs(); // fetch immediately
            systemLogInterval = setInterval(fetchSystemLogs, 1000);
        }
        function stopSystemLogPolling() {
            if (systemLogInterval) {
                clearInterval(systemLogInterval);
                systemLogInterval = null;
            }
        }
        function fetchSystemLogs() {
            fetch('/api/logs')
                .then(res => res.json())
                .then(data => {
                    const logDiv = document.getElementById('system-log');
                    logDiv.innerHTML = '';
                    data.logs.forEach(log => {
                        let logClass = log.level === 'success' ? 'log-success' : log.level === 'error' ? 'log-error' : 'log-info';
                        logDiv.innerHTML += `<div class="${logClass}">[${log.timestamp.slice(11,19)}] ${log.message}</div>`;
                    });
                    logDiv.scrollTop = logDiv.scrollHeight;
                });
        }

        // Patch trainModel and analyzeRisks to use polling
        function trainModel() {
            showLoading('train-loading');
            logMessage('Training LSTM model for trajectory prediction...');
            startSystemLogPolling();
            fetch('/api/train-model', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    hideLoading('train-loading');
                    stopSystemLogPolling();
                    if (data.status === 'success') {
                        logMessage(data.message, 'success');
                        updateStatus();
                        updateGlobalStatus('training-status', true);
                        updateGlobalStatus('last-training-time', new Date().toLocaleTimeString());
                        updateGlobalStatus('training-count', data.total_trainings);
                        // updateTrainingCountdown(); // Removed 1-second countdown
                    } else {
                        logMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading('train-loading');
                    stopSystemLogPolling();
                    logMessage('Error training model: ' + error.message, 'error');
                });
        }

        function analyzeRisks() {
            showLoading('risk-loading');
            logMessage('Analyzing collision risks for ISS (25544)...');
            startSystemLogPolling();
            fetch('/api/analyze-risks', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sat_id: '25544' })
            })
                .then(response => response.json())
                .then(data => {
                    hideLoading('risk-loading');
                    stopSystemLogPolling();
                    if (data.status === 'success') {
                        logMessage(`Found ${data.total_risks} collision risks`, 'success');
                        displayRiskResults(data.risk_table);
                    } else {
                        logMessage(data.message, 'error');
                    }
                })
                .catch(error => {
                    hideLoading('risk-loading');
                    stopSystemLogPolling();
                    logMessage('Error analyzing risks: ' + error.message, 'error');
                });
        }

        function displayRiskResults(riskTable) {
            const resultsDiv = document.getElementById('risk-results');
            
            if (typeof riskTable === 'string') {
                resultsDiv.innerHTML = `<p class="text-muted">${riskTable}</p>`;
                return;
            }
            
            if (riskTable.length === 0) {
                resultsDiv.innerHTML = '<p class="text-success">No collision risks detected!</p>';
                return;
            }
            
            let tableHtml = `
                <div class="table-responsive risk-table">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Object</th>
                                <th>Distance (km)</th>
                                <th>Velocity (km/s)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            riskTable.forEach(risk => {
                tableHtml += `
                    <tr>
                        <td><small>${risk.debris_name || risk.debris_id}</small></td>
                        <td><span class="badge bg-${risk.distance_km < 10 ? 'danger' : 'warning'}">${risk.distance_km.toFixed(1)}</span></td>
                        <td><small>${risk.relative_velocity.toFixed(1)}</small></td>
                    </tr>
                `;
            });
            
            tableHtml += '</tbody></table></div>';
            resultsDiv.innerHTML = tableHtml;
        }

        let bgLogInterval = null;
        let bgLogVisible = false;
        function toggleBgLog() {
            bgLogVisible = !bgLogVisible;
            document.getElementById('bg-log-panel').style.display = bgLogVisible ? 'block' : 'none';
            document.getElementById('toggle-bg-log').innerHTML = bgLogVisible ? '<i class="fas fa-terminal"></i> Hide Background Logs' : '<i class="fas fa-terminal"></i> Show Background Logs';
            if (bgLogVisible) {
                fetchBgLogs();
                bgLogInterval = setInterval(fetchBgLogs, 2000);
            } else {
                clearInterval(bgLogInterval);
            }
        }
        function fetchBgLogs() {
            fetch('/api/logs')
                .then(res => res.json())
                .then(data => {
                    const logDiv = document.getElementById('bg-log-entries');
                    logDiv.innerHTML = '';
                    const now = Date.now();
                    data.logs.forEach(log => {
                        const logTime = new Date(log.timestamp).getTime();
                        const elapsed = Math.floor((now - logTime) / 1000);
                        let timer = elapsed < 60 ? `${elapsed}s ago` : `${Math.floor(elapsed/60)}m ${elapsed%60}s ago`;
                        let logClass = log.level === 'success' ? 'log-success' : log.level === 'error' ? 'log-error' : 'log-info';
                        logDiv.innerHTML += `<div class="${logClass}">[${log.timestamp.slice(11,19)}] ${log.message}<span class="log-timer">${timer}</span></div>`;
                    });
                    logDiv.scrollTop = logDiv.scrollHeight;
                });
        }

        // --- Global Status Polling ---
        let globalStatusInterval = null;
        function startGlobalStatusPolling() {
            if (globalStatusInterval) return;
            fetchGlobalStatus(); // fetch immediately
            globalStatusInterval = setInterval(fetchGlobalStatus, 5000); // Poll every 5 seconds
        }
        function stopGlobalStatusPolling() {
            if (globalStatusInterval) {
                clearInterval(globalStatusInterval);
                globalStatusInterval = null;
            }
        }
        function fetchGlobalStatus() {
            fetch('/api/global-status')
                .then(res => res.json())
                .then(data => {
                    // Update download status
                    document.getElementById('last-download-time').textContent = data.last_tle_download.formatted;
                    document.getElementById('download-count').textContent = data.counts.download_count;
                    document.getElementById('download-status').className = 'status-indicator ' + (data.last_tle_download.can_download ? 'status-success' : 'status-warning');
                    // Show hours and minutes for countdown
                    let downloadCountdown = data.last_tle_download.cooldown_formatted;
                    if (downloadCountdown !== 'Ready now') {
                        const hourMatch = downloadCountdown.match(/(\d+)h/);
                        const minMatch = downloadCountdown.match(/(\d+)m/);
                        if (hourMatch && minMatch) {
                            downloadCountdown = `${hourMatch[1]}h ${minMatch[1]}m`;
                        } else if (minMatch) {
                            downloadCountdown = `${minMatch[1]} min`;
                        } else {
                            downloadCountdown = '1 min';
                        }
                    }
                    document.getElementById('download-countdown').textContent = downloadCountdown;
                    // Update training status
                    document.getElementById('last-training-time').textContent = data.last_model_training.formatted;
                    document.getElementById('training-count').textContent = data.counts.training_count;
                    document.getElementById('training-status').className = 'status-indicator ' + (data.last_model_training.can_train ? 'status-success' : 'status-warning');
                    let trainingCountdown = data.last_model_training.cooldown_formatted;
                    if (trainingCountdown !== 'Ready now') {
                        const hourMatch = trainingCountdown.match(/(\d+)h/);
                        const minMatch = trainingCountdown.match(/(\d+)m/);
                        if (hourMatch && minMatch) {
                            trainingCountdown = `${hourMatch[1]}h ${minMatch[1]}m`;
                        } else if (minMatch) {
                            trainingCountdown = `${minMatch[1]} min`;
                        } else {
                            trainingCountdown = '1 min';
                        }
                    }
                    document.getElementById('training-countdown').textContent = trainingCountdown;
                })
                .catch(error => {
                    console.error('Error fetching global status:', error);
                });
        }

        function updateGlobalStatus(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                if (typeof value === 'string') {
                    element.textContent = value;
                } else if (typeof value === 'number') {
                    element.textContent = value;
                } else if (typeof value === 'boolean') {
                    element.className = 'status-indicator ' + (value ? 'status-success' : 'status-error');
                }
            }
        }

        // Remove all 1-second countdown intervals and update functions for download/training countdowns.
    </script>
</body>
</html> 